name: Test and Deploy to Production

on:
  workflow_dispatch:

  push:
    branches:
      - production
  pull_request:
    branches:
      - production

jobs:
  test:
    uses: ./.github/workflows/test.common.yml
    with:
      run_production_tests: true

  get-environment-variables:
    name: Get environment variables for production
    runs-on: ubuntu-latest
    outputs:
      production_destination: ${{ steps.set_destination.outputs.production_destination }}
    steps:
      - name: Set PRODUCTION_DESTINATION to environment
        id: set_destination
        run: |
          echo "::set-output name=production_destination::${{ secrets.PRODUCTION_DESTINATION }}"

          MY_SECRET="${{secrets.PRODUCTION_DESTINATION}}"
          MODIFIED_SECRET="${MY_SECRET}-additional-string"
          echo "1. MOdified secret is : $MODIFIED_SECRET"
          echo "2. MOdified secret is : ${MODIFIED_SECRET}"
          

          echo "Github output is $GITHUB_OUTPUT"

  build-and-deploy:
    name: Build and Deploy to Production
    needs:
      - test
      - get-environment-variables
    uses: ./.github/workflows/deploy.common.yml
    with:
      ssh_destination_dir: ${{ needs.get-environment-variables.outputs.production_destination }}
      ssh_deployment_url: ${{ vars.PRODUCTION_DOMAIN_NAME }}
    secrets: inherit
