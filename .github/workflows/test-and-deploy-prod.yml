name: Test and Deploy to Production

on:
  workflow_dispatch:

  push:
    branches:
      - production
  pull_request:
    branches:
      - production

jobs:
  test:
    uses: ./.github/workflows/test.common.yml
    with:
      run_production_tests: true
  get-environment-variables:
    name: Get environment variables for production
    runs-on: ubuntu-latest
    outputs:
      production_destination: ${{ steps.set_destination.outputs.production_destination }}
    steps:
      - name: Set PRODUCTION_DESTINATION to environment
        id: set_destination
        run: |
          echo "production_destination=${{ secrets.PRODUCTION_DESTINATION }}" >> $GITHUB_OUTPUT

  build-and-deploy:
    name: Build and Deploy to Production
    needs:
      - test
      - get-environment-variables
    uses: ./.github/workflows/deploy.common.yml
    with:
      ssh_destination_dir: ${{ needs.get-environment-variables.outputs.production_destination }}
      ssh_deployment_url: ${{ vars.PRODUCTION_DOMAIN_NAME}}
    secrets:
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      AWS_REMOTE_IP: ${{ secrets.AWS_REMOTE_IP }}
      AWS_USER: ${{ secrets.AWS_USER }}      

    # REQUIREMENT FOR PRODUCTION ADMINISTRATORS TO ACCEPT DEPLOYMENT
    # environment:
    #     name: production

    #   - name: Notify Slack of Production Deployment Start
    #     uses: slackapi/slack-github-action@v1.23.0
    #     with:
    #         slack-message: "Production deployment started."
    #     env:
    #         SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL_PROD }}

    #   - name: Verify Production Deployment
    #     run: curl -f ${{ secrets.REMOTE_DOMAIN_PRODUCTION_NAME}}/health-check || exit 1
